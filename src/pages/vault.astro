---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import VaultCard from '../components/VaultCard.astro';

const allEntries = await getCollection('vault');
const sortedEntries = allEntries.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Helper for slugs
const slugify = (text: string) => 
  text.toString().toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove accents
    .replace(/\s+/g, '-') 
    .replace(/[^\w-]+/g, '')
    .replace(/--+/g, '-')
    .replace(/^-+/, '')
    .replace(/-+$/, '');

const entriesWithSlugs = sortedEntries.map(entry => ({
  ...entry,
  slug: `${entry.data.pubDate.getFullYear()}-${slugify(entry.data.title)}`
}));

// Categories for filtering
const categories = [
  { id: 'all', label: 'Vše', color: 'bg-charcoal' },
  { id: 'cnk', label: 'Cesty na kole', color: 'bg-joy-yellow' },
  { id: 'cvut-fel', label: 'ČVUT FEL', color: 'bg-sky-blue' },
  { id: 'spse-v-uzlabine', label: 'SPŠE Úžlabina', color: 'bg-orange-500' },
  { id: 'blog', label: 'Blog', color: 'bg-slate-400' },
];

const categoryNodeMap = {
  cnk: 'bg-joy-yellow',
  'cvut-fel': 'bg-sky-blue',
  'spse-v-uzlabine': 'bg-orange-500',
  blog: 'bg-slate-400',
  news: 'bg-slate-300',
};
---

<Layout title="The Vault | Michal Trs Architektura vzpomínek">
  <main class="max-w-4xl mx-auto px-6 py-20">
    <header class="mb-16 text-center" data-animate>
      <h1 class="text-4xl md:text-6xl font-extrabold text-charcoal mb-4 font-outfit">The Vault</h1>
      <p class="text-xl text-charcoal/60 mb-10">Digitální historie, archivy a vzpomínky z let 2006–2013.</p>
      
      <!-- Filter Bar -->
      <div class="flex flex-wrap justify-center gap-3 mb-10" id="filter-bar">
        {categories.map(cat => (
          <button 
            data-filter={cat.id}
            class={`filter-btn px-4 py-2 rounded-full text-sm font-bold border-2 transition-all 
              ${cat.id === 'all' 
                ? 'active bg-charcoal text-white border-charcoal'
                : 'bg-transparent text-charcoal/70 border-charcoal/20 hover:border-charcoal/40'}`}
          >
            {cat.label}
          </button>
        ))}
      </div>
    </header>

    <div class="relative min-h-[400px]">
      <!-- Central Timeline Line -->
      <div class="absolute left-4 md:left-1/2 top-0 bottom-0 w-1 bg-slate-100 -translate-x-1/2 z-0"></div>

      <div class="space-y-16 relative z-10" id="timeline-container">
        {entriesWithSlugs.map((entry, idx) => {
          const nodeClass = categoryNodeMap[entry.data.category] || categoryNodeMap.news;
          return (
            <div 
              class="timeline-entry relative flex items-center gap-8 md:even:flex-row md:odd:flex-row-reverse" 
              data-category={entry.data.category}
              id={entry.slug}
            >
              {/* Content Card */}
              <div class="w-full md:w-[calc(50%-2rem)] transition-all duration-500">
                <VaultCard entry={entry} />
              </div>

              {/* Node on Timeline */}
              <div class={`absolute left-4 md:left-1/2 w-6 h-6 rounded-full border-4 border-white shadow -translate-x-1/2 z-20 transition-transform hover:scale-125 ${nodeClass}`}>
              </div>
              
              {/* Empty side for spacing */}
              <div class="hidden md:block w-full md:w-[calc(50%-2rem)]"></div>
            </div>
          );
        })}
      </div>
    </div>

  </main>
</Layout>

<script>
  function init() {
    const buttons = document.querySelectorAll('.filter-btn');
    const entries = document.querySelectorAll('.timeline-entry');

    function applyFilter(filter: string, updateUrl = false) {
      // Update URL
      if (updateUrl) {
        const url = new URL(window.location.href);
        url.hash = '';
        if (filter === 'all') {
          url.searchParams.delete('category');
        } else {
          url.searchParams.set('category', filter);
        }
        history.replaceState(null, '', url.toString());
      }

      // Update button states
      buttons.forEach(btn => {
        const btnFilter = btn.getAttribute('data-filter');
        if (btnFilter === filter) {
          btn.classList.add('active', 'bg-charcoal', 'text-white', 'border-charcoal');
          btn.classList.remove('bg-transparent', 'text-charcoal/70', 'border-charcoal/20');
        } else {
          btn.classList.remove('active', 'bg-charcoal', 'text-white', 'border-charcoal');
          btn.classList.add('bg-transparent', 'text-charcoal/70', 'border-charcoal/20');
        }
      });

      // Filter entries
      entries.forEach(entry => {
        const entryCat = entry.getAttribute('data-category');
        const htmlEntry = entry as HTMLElement;

        if (filter === 'all' || entryCat === filter) {
          htmlEntry.style.display = 'flex';
          // Force reflow for transform animation
          htmlEntry.offsetHeight;
          htmlEntry.style.opacity = '1';
          htmlEntry.style.transform = 'translateY(0)';
        } else {
          htmlEntry.style.opacity = '0';
          htmlEntry.style.transform = 'translateY(20px)';
          // Hide after transition
          setTimeout(() => {
            if (htmlEntry.style.opacity === '0') {
              htmlEntry.style.display = 'none';
            }
          }, 300);
        }
      });
    }

    function handleDeepLink() {
      const hash = decodeURIComponent(window.location.hash.substring(1));
      const params = new URLSearchParams(window.location.search);
      const categoryParam = params.get('category');

      if (hash) {
        const target = document.getElementById(hash);
        if (target) {
          const category = target.getAttribute('data-category');
          if (category) applyFilter(category);

          setTimeout(() => {
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const card = target.querySelector('.timeline-card');
            if (card) {
              card.classList.add('highlight-card');
              setTimeout(() => card.classList.remove('highlight-card'), 3000);
            }
          }, 500);
        }
      } else if (categoryParam) {
        applyFilter(categoryParam);
      }
    }

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const filter = btn.getAttribute('data-filter');
        if (filter) applyFilter(filter, true);
      });
    });

    handleDeepLink();
  }

  // Initial call and handles view transitions
  init();
  document.addEventListener('astro:after-swap', init);
</script>

<style>
  .font-outfit { font-family: 'Outfit', sans-serif; }
  .timeline-entry {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  .highlight-card {
    animation: pulse-highlight 2s ease-out;
  }
  @keyframes pulse-highlight {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.4); }
    30% { transform: scale(1.02); box-shadow: 0 0 0 20px rgba(14, 165, 233, 0); }
    100% { transform: scale(1); }
  }
</style>
